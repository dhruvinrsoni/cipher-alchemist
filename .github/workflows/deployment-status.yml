name: 📊 Deployment Status & Health Check

on:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🛒 Checkout Code
        uses: actions/checkout@v4

      - name: 🌐 Check Live Demo Status
        run: |
          DEMO_URL="https://dhruvinrsoni.github.io/cipher-alchemist/"
          
          echo "🔍 Checking live demo at: $DEMO_URL"
          
          # Check if site is accessible
          if curl -f -s -o /dev/null "$DEMO_URL"; then
            echo "✅ Live demo is accessible"
            STATUS="🟢 Online"
          else
            echo "❌ Live demo is not accessible"
            STATUS="🔴 Offline"
          fi
          
          echo "DEMO_STATUS=$STATUS" >> $GITHUB_ENV

      - name: 📋 Get Current Version Info
        run: |
          if [ -f version.txt ]; then
            CURRENT_VERSION=$(cat version.txt)
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "📄 Current version: $CURRENT_VERSION"
          else
            echo "CURRENT_VERSION=Unknown" >> $GITHUB_ENV
            echo "⚠️ Version file not found"
          fi

      - name: 🏷️ Get Latest Release Info
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "No tags")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "🏷️ Latest tag: $LATEST_TAG"
          
          # Get release count
          RELEASE_COUNT=$(git tag -l | grep "^v" | wc -l)
          echo "RELEASE_COUNT=$RELEASE_COUNT" >> $GITHUB_ENV
          echo "📊 Total releases: $RELEASE_COUNT"

      - name: 📊 Generate Status Report
        run: |
          echo "# 📊 Cipher Alchemist Deployment Status" > STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "**Generated:** $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" >> STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "## 🌐 Live Demo Status" >> STATUS_REPORT.md
          echo "- **URL:** [dhruvinrsoni.github.io/cipher-alchemist](https://dhruvinrsoni.github.io/cipher-alchemist/)" >> STATUS_REPORT.md
          echo "- **Status:** ${{ env.DEMO_STATUS }}" >> STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "## 📦 Version Information" >> STATUS_REPORT.md
          echo "- **Current Version:** ${{ env.CURRENT_VERSION }}" >> STATUS_REPORT.md
          echo "- **Latest Tag:** ${{ env.LATEST_TAG }}" >> STATUS_REPORT.md
          echo "- **Total Releases:** ${{ env.RELEASE_COUNT }}" >> STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "## 🔄 Available Rollback Points" >> STATUS_REPORT.md
          echo "\`\`\`" >> STATUS_REPORT.md
          git tag -l | grep "^v" | sort -V | tail -10 >> STATUS_REPORT.md || echo "No version tags found" >> STATUS_REPORT.md
          echo "\`\`\`" >> STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "## 📋 Recent Commits" >> STATUS_REPORT.md
          echo "\`\`\`" >> STATUS_REPORT.md
          git log --oneline -10 >> STATUS_REPORT.md
          echo "\`\`\`" >> STATUS_REPORT.md
          echo "" >> STATUS_REPORT.md
          echo "---" >> STATUS_REPORT.md
          echo "*🔮 Status generated by GitHub Actions*" >> STATUS_REPORT.md

      - name: 📄 Display Status Report
        run: |
          echo "📊 Deployment Status Report:"
          echo "================================"
          cat STATUS_REPORT.md
          echo "================================"

      - name: 💾 Archive Status Report
        uses: actions/upload-artifact@v3
        with:
          name: deployment-status-$(date +%Y%m%d-%H%M%S)
          path: STATUS_REPORT.md
          retention-days: 30
