name: ðŸ“Š Deployment Status

on:
  workflow_dispatch:
    inputs:
      detailed_report:
        description: 'Generate detailed report'
        required: false
        default: true
        type: boolean
      custom_url:
        description: 'Custom URL to check (optional)'
        required: false
        type: string
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # âœ… NEW: Dynamic job name with IST timestamp
    name: Health Check - ${{ format('{0}', github.run_id) }}
    
    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ• Set IST Timestamp
        id: timestamp
        run: |
          IST_TIME=$(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')
          IST_SHORT=$(TZ='Asia/Kolkata' date '+%m/%d %H:%M IST')
          echo "ist_time=${IST_TIME}" >> $GITHUB_OUTPUT
          echo "ist_short=${IST_SHORT}" >> $GITHUB_OUTPUT
          echo "ðŸ“… Current IST Time: ${IST_TIME}"

      - name: ðŸ” Check Demo Status
        id: demo_check
        run: |
          # âœ… FIXED: Use custom URL if provided, otherwise default
          if [ -n "${{ github.event.inputs.custom_url }}" ]; then
            DEMO_URL="${{ github.event.inputs.custom_url }}"
          else
            DEMO_URL="https://dhruvinrsoni.github.io/cipher-alchemist/"
          fi
          
          echo "ðŸ” Checking URL: $DEMO_URL"
          
          # âœ… ENHANCED: Multiple check types
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEMO_URL" || echo "000")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$DEMO_URL" || echo "0")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "status=âœ… Online (${HTTP_STATUS})" >> $GITHUB_OUTPUT
            echo "response_time=${RESPONSE_TIME}s" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Offline (${HTTP_STATUS})" >> $GITHUB_OUTPUT
            echo "response_time=N/A" >> $GITHUB_OUTPUT
          fi
          
          echo "url=$DEMO_URL" >> $GITHUB_OUTPUT
          echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Generate Status Report
        if: ${{ github.event.inputs.detailed_report == 'true' || github.event_name == 'schedule' }}
        run: |
          # âœ… FIXED: Check if STATUS_REPORT.md exists, create if not
          echo "ðŸ” Checking if STATUS_REPORT.md exists..."
          
          if [ ! -f "STATUS_REPORT.md" ]; then
            echo "ðŸ“ STATUS_REPORT.md not found, creating new file..."
            touch STATUS_REPORT.md
          else
            echo "âœ… STATUS_REPORT.md already exists, updating..."
          fi
          
          # Generate the status report
          cat > STATUS_REPORT.md << EOF
          # ðŸ“Š Cipher Alchemist - Deployment Status
          
          **Generated:** ${{ steps.timestamp.outputs.ist_time }}
          **Trigger:** ${{ github.event_name }}
          **Run ID:** ${{ github.run_id }}
          
          ## ðŸŒ Live Demo Health
          - **URL:** [${{ steps.demo_check.outputs.url }}](${{ steps.demo_check.outputs.url }})
          - **Status:** ${{ steps.demo_check.outputs.status }}
          - **HTTP Code:** ${{ steps.demo_check.outputs.http_status }}
          - **Response Time:** ${{ steps.demo_check.outputs.response_time }}
          
          ## ðŸ“¦ Version Information
          - **Current Version:** \$(cat version.txt 2>/dev/null || echo "Unknown")
          - **Latest Tag:** \$(git describe --tags --abbrev=0 2>/dev/null || echo "No tags")
          - **Total Releases:** \$(git tag -l | grep "^v" | wc -l)
          - **Last Commit:** \$(git log -1 --pretty=format:"%h - %s (%cr)")
          
          ## ðŸ”„ Available Versions
          \`\`\`
          \$(git tag -l | grep "^v" | sort -V | tail -5)
          \`\`\`
          
          ## ðŸ“‹ Recent Activity
          \`\`\`
          \$(git log --oneline -5)
          \`\`\`
          
          ## ðŸ“ˆ Repository Stats
          - **Total Commits:** \$(git rev-list --all --count)
          - **Contributors:** \$(git log --format='%an' | sort -u | wc -l)
          - **Branches:** \$(git branch -r | wc -l)
          
          ## ðŸ“Š Check History
          | Check Time | Status | Response Time | HTTP Code |
          |------------|--------|---------------|-----------|
          | ${{ steps.timestamp.outputs.ist_time }} | ${{ steps.demo_check.outputs.status }} | ${{ steps.demo_check.outputs.response_time }} | ${{ steps.demo_check.outputs.http_status }} |
          
          ---
          *Status report generated by GitHub Actions*  
          *Last Updated: ${{ steps.timestamp.outputs.ist_time }}*
          EOF
          
          echo "âœ… STATUS_REPORT.md updated successfully"
          
          # Show file size for verification
          ls -la STATUS_REPORT.md

      - name: ðŸ’¾ Archive Status Report
        if: ${{ github.event.inputs.detailed_report == 'true' || github.event_name == 'schedule' }}
        uses: actions/upload-artifact@v4
        with:
          # âœ… ENHANCED: Include IST timestamp in artifact name
          name: deployment-status-${{ steps.timestamp.outputs.ist_short }}-run${{ github.run_id }}
          path: STATUS_REPORT.md
          retention-days: 30

      # âœ… NEW: Send notification on failure (optional)
      - name: ðŸš¨ Alert on Failure
        if: ${{ steps.demo_check.outputs.http_status != '200' && github.event_name == 'schedule' }}
        run: |
          echo "ðŸš¨ ALERT: Demo site is down!"
          echo "URL: ${{ steps.demo_check.outputs.url }}"
          echo "Status: ${{ steps.demo_check.outputs.status }}"
          echo "HTTP Code: ${{ steps.demo_check.outputs.http_status }}"
          echo "Time: ${{ steps.timestamp.outputs.ist_time }}"
          
          # âœ… ENHANCED: Create failure report
          cat > FAILURE_REPORT.md << EOF
          # ðŸš¨ DEPLOYMENT FAILURE ALERT
          
          **Alert Time:** ${{ steps.timestamp.outputs.ist_time }}
          **Trigger:** ${{ github.event_name }}
          
          ## ðŸ”´ Failure Details
          - **URL:** ${{ steps.demo_check.outputs.url }}
          - **Status:** ${{ steps.demo_check.outputs.status }}
          - **HTTP Code:** ${{ steps.demo_check.outputs.http_status }}
          - **Response Time:** ${{ steps.demo_check.outputs.response_time }}
          
          ## ðŸ”§ Recommended Actions
          1. Check GitHub Pages deployment status
          2. Verify DNS configuration
          3. Check for recent commits that might have broken the site
          4. Manual verification: ${{ steps.demo_check.outputs.url }}
          
          ---
          *Failure alert generated by GitHub Actions*
          EOF
          
          # Future: Add Slack/Discord/Email notification here

      - name: ðŸ“„ Display Status
        run: |
          echo "ðŸ“Š Deployment Status Summary"
          echo "============================"
          echo "ðŸ• Check Time: ${{ steps.timestamp.outputs.ist_time }}"
          echo "ðŸŒ Demo Status: ${{ steps.demo_check.outputs.status }}"
          echo "ðŸ”— Demo URL: ${{ steps.demo_check.outputs.url }}"
          echo "âš¡ Response Time: ${{ steps.demo_check.outputs.response_time }}"
          echo "ðŸ“‹ HTTP Code: ${{ steps.demo_check.outputs.http_status }}"
          echo "ðŸƒ Run ID: ${{ github.run_id }}"
          echo "============================"

      # âœ… NEW: Update workflow summary with IST timestamp
      - name: ðŸ“‹ Update Job Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Deployment Status - ${{ steps.timestamp.outputs.ist_time }}
          
          ## ðŸŒ Health Check Results
          | Metric | Value |
          |--------|-------|
          | ðŸ”— URL | [${{ steps.demo_check.outputs.url }}](${{ steps.demo_check.outputs.url }}) |
          | ðŸ“Š Status | ${{ steps.demo_check.outputs.status }} |
          | âš¡ Response Time | ${{ steps.demo_check.outputs.response_time }} |
          | ðŸ”¢ HTTP Code | ${{ steps.demo_check.outputs.http_status }} |
          | ðŸ• Check Time | ${{ steps.timestamp.outputs.ist_time }} |
          | ðŸŽ¯ Trigger | ${{ github.event_name }} |
          
          ## ðŸ“¦ Quick Stats
          - **Current Version:** \$(cat version.txt 2>/dev/null || echo "Unknown")
          - **Latest Tag:** \$(git describe --tags --abbrev=0 2
